<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
    <title>一同養樹</title>
    <script src="js/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <link rel="stylesheet" type="text/css" href="css/adopt_tree.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

</head>

<body>
    @@include('layout/header.html')
    <article id="tree_list">
        <ul class="breadcrumb">
            <li><a href="./home.html">首頁</a></li>
            <li><a href="#">一同養樹</a></li>
        </ul>
        <div class="search">
            <div class="select">
                <select name="fruit" id="fruit" v-model="input.typefruit">
                    <option value="">選擇水果</option>
                    <option :value="fruit.fruit_id" v-for="fruit in fruits">{{fruit.fruit_name}}</option>
                </select>

                <select name="city" id="city" v-model="input.typecity">
                    <option value="">選擇地區</option>
                    <option :value="city.city_id" v-for="city in citys">{{city.city_name}}</option>
                </select>

            </div>
            <select name="price" id="price" v-model="input.typeprice">
                <option value="" disabled selected>價格排序</option>
                <option value="價格高到低">價格高到低</option>
                <option value="價格低到高">價格低到高</option>
            </select>
        </div>
        <section>
            <div class="content" v-for="tree in more_trees">
                <a :href="'tree_growing.html?tree_id=' + tree.tree_id">
                    <div class="con_img">
                        <div class="black_bg animate__animated animate__flipInX  animate__fast">
                            <input type="button" value="查看詳情">
                        </div>
                        <img :src="'images/tree/' + tree.treehistory_img" alt="認養果樹照片">

                    </div>
                    <div class="con_textbox">
                        <div class="con_text_img">
                            <img :src="'images/svg/adopt_tree_' + tree.fruit_id + '.svg'" alt="果實">
                        </div>
                        <div class="con_text">
                            <h3>{{tree.tree_name}}</h3>
                            <p>認養價格: {{tree.tree_price}}$/年</p>
                        </div>
                    </div>
                </a>
            </div>

        </section>
        <p class="load">load more...</p>
    </article>
    @@include('layout/footer.html')

    <script type="text/javascript">
        let tree_list = new Vue({
            el: "#tree_list",
            data: {
                trees: [],
                fruits:[],
                citys:[],
                input: {
                    typefruit: '',
                    typecity: '',
                    typeprice: '',
                },
                index:1,

            },
            methods: {
                getdata() {
                    if (window.location.search != 0) {
                        this.input.typefruit = window.location.search.split("?")[1].split("=")[1]
                    }
                },
                handleScroll() {
                    if ($( window ).height() + $(window).scrollTop()+1 >= $( document ).height()) {
                        this.index=this.index+1;
                    }
                },
               
            },
            computed: {
                more_trees() {
                    return this.sequence.slice(0, 6*this.index);
                },
                select() {
                    if (this.input.typefruit != '' && this.input.typecity != '') {
                        return this.trees.filter(tree => {
                            return tree.fruit_id == this.input.typefruit && tree.city_id == this.input.typecity
                        })
                    } else if (this.input.typefruit != '' && this.input.typecity == '') {
                        return this.trees.filter(tree => {
                            return tree.fruit_id == this.input.typefruit
                        })
                    } else if (this.input.typefruit == '' && this.input.typecity != '') {
                        return this.trees.filter(tree => {
                            return tree.city_id == this.input.typecity
                        })
                    } else {
                        return this.trees
                    }
                },
                sequence() {
                    if (this.input.typeprice == "價格高到低") {
                        return this.select.sort(function (p1, p2) {
                            return p2.tree_price - p1.tree_price
                        })
                    } else if (this.input.typeprice == "價格低到高") {
                        return this.select.sort(function (p1, p2) {
                            return p1.tree_price - p2.tree_price
                        })
                    } else {
                        return this.select
                    }
                },
            },
            created() {
                window.addEventListener("scroll", this.handleScroll);
            },
            mounted() {
                this.getdata();
            },
        })

        //連接php
        //#getTree_list
        function getTree_list() {
            let xhr = new XMLHttpRequest();
            xhr.onload = function () {
                console.log(JSON.parse(xhr.responseText))
                tree_list.trees = JSON.parse(xhr.responseText)
            }
            xhr.open("get", "./phps/getTree_list.php", true);
            xhr.send(null);
        }

        //連接php
        //#getFruit
        function getFruits() {
            let xhr2 = new XMLHttpRequest();
            xhr2.onload = function () {
                console.log(JSON.parse(xhr2.responseText))
                tree_list.fruits = JSON.parse(xhr2.responseText)
            }
            xhr2.open("get", "./phps/getFruit.php", true);
            xhr2.send(null);
        }

                //連接php
        //#getFruit
        function getCitys() {
            let xhr3 = new XMLHttpRequest();
            xhr3.onload = function () {
                console.log(JSON.parse(xhr3.responseText))
                tree_list.citys = JSON.parse(xhr3.responseText)
            }
            xhr3.open("get", "./phps/getCity.php", true);
            xhr3.send(null);
        }

        window.addEventListener("load", function () {
            //------------------------網頁的初始設定
            getTree_list();
            getFruits();
            getCitys();
        })
    </script>
</body>

</html>